# EventBridge スケジュール設定ガイド

## 概要
EventBridge を使用してLambda関数を定期実行するスケジュール設定の手順です。

## 1. EventBridge Rule 作成

### AWS Console での手順
1. **EventBridge** サービスに移動
2. 左メニューから **「ルール」** を選択
3. **「ルールの作成」** ボタンをクリック

### 基本設定
- **名前**: `divergence-checker-schedule`
- **説明**: `ダイバージェンス検知Lambda関数の定期実行`
- **イベントバス**: `default`
- **ルールタイプ**: **「スケジュール」** を選択

## 2. スケジュールパターン設定

### スケジュール式
**「Cron式」** を選択し、以下のパターンから選択:

#### 🕘 日本時間 月曜7時〜土曜6時 15分毎実行（推奨）
```
cron(*/15 22 * * SUN)
cron(*/15 * * * MON-FRI)
cron(*/15 0-21 * * SAT)
```
または統合版：
```
cron(*/15 22 * * 0)
cron(*/15 * * * 1-5)
cron(*/15 0-21 * * 6)
```
- 日本時間：月曜7時〜土曜6時に15分毎実行
- より頻繁な監視で早期ダイバージェンス検知

#### 🕐 4時間毎実行
```
cron(0 */4 * * *)
```
- 毎日4時間毎に実行（0時、4時、8時、12時、16時、20時）

#### 🕘 営業日の朝・昼・夕実行
```
cron(0 9,12,18 * * MON-FRI)
```
- 月曜日〜金曜日の9時、12時、18時に実行

#### 🕒 毎時実行
```
cron(0 * * * *)
```
- 毎時実行（標準的な監視頻度）

### Cron式の説明
```
cron(分 時 日 月 曜日 年)
```
- **分**: 0-59
- **時**: 0-23
- **日**: 1-31
- **月**: 1-12
- **曜日**: MON-SUN（1-7）
- **年**: オプション

### 例
- `*` = すべての値
- `*/4` = 4つおき
- `9-21` = 9時から21時まで
- `MON-FRI` = 月曜日から金曜日まで

## 3. ターゲット設定

### ターゲット選択
1. **「ターゲットを追加」** をクリック
2. **「AWS サービス」** を選択
3. **「Lambda function」** を選択

### Lambda設定
- **関数**: `divergence-checker` を選択
- **バージョン/エイリアス**: `$LATEST`（デフォルト）

### 追加設定（オプション）
**「追加設定」** で以下を設定可能:
- **最大イベント経過時間**: 1時間
- **再試行ポリシー**: 最大再試行回数 = 2

## 4. 権限設定

EventBridge が Lambda 関数を実行できるように権限が自動で設定されます。

### 手動で権限確認（必要な場合）
Lambda関数の「設定」→「権限」で以下のリソースベースポリシーが追加されていることを確認:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "events.amazonaws.com"
      },
      "Action": "lambda:InvokeFunction",
      "Resource": "arn:aws:lambda:region:account:function:divergence-checker",
      "Sid": "EventBridgeInvokeFunction"
    }
  ]
}
```

## 5. テスト実行

### 手動テスト
1. EventBridge ルールの詳細画面で **「テスト」** をクリック
2. **「テストイベントの作成」**
3. **「空のイベント」** を選択
4. **「テストの実行」**

### Lambda関数での確認
Lambda関数の「監視」→「ログ」でCloudWatch Logsを確認

## 6. 監視設定

### CloudWatch Alarms 作成
1. **CloudWatch** サービスに移動
2. **「アラーム」** → **「アラームの作成」**

#### エラー監視アラーム
- **メトリクス**: `AWS/Lambda` → `Errors`
- **関数名**: `divergence-checker`
- **閾値**: エラー数 >= 1
- **期間**: 5分間
- **評価期間**: 1回

#### 実行時間監視アラーム
- **メトリクス**: `AWS/Lambda` → `Duration`
- **関数名**: `divergence-checker`
- **閾値**: 実行時間 >= 25000ms（25秒）
- **期間**: 5分間

### SNS通知設定
1. **SNS** サービスでトピックを作成
2. Email等で通知先を設定
3. CloudWatch AlarmのアクションにSNSトピックを追加

## 7. 本番運用の推奨設定

### 市場時間に合わせたスケジュール
```bash
# 日本時間 月曜7時〜土曜6時（24時間監視）
cron(*/15 22 * * 0)       # 日曜22時〜（月曜7時〜）
cron(*/15 * * * 1-5)      # 月〜金曜日終日
cron(*/15 0-21 * * 6)     # 土曜0時〜21時（〜土曜6時）

# 東京市場時間のみ（JST 9:00-15:00）
cron(*/15 0-6 * * 1-5)    # UTC 0-6時 = JST 9-15時
```

### 祝日対応
EventBridge の cron 式では祝日を除外できないため、Lambda関数内で祝日判定ロジックを追加することを推奨。

## 8. トラブルシューティング

### よくある問題

#### ルールが実行されない
1. **ルールが有効になっているか確認**
   - EventBridge → ルール → 状態が「有効」
2. **タイムゾーン確認**
   - Cron式はUTC時間で設定
   - JST = UTC + 9時間
3. **Lambda権限確認**
   - リソースベースポリシーが正しく設定されているか

#### Lambda関数でエラーが発生
1. **CloudWatch Logs確認**
   - `/aws/lambda/divergence-checker`
2. **タイムアウト確認**
   - Lambda関数のタイムアウトが30秒に設定されているか
3. **環境変数確認**
   - `API_ENDPOINT`、`USERS_TO_CHECK`が正しく設定されているか

#### LINE通知が届かない
1. **API_ENDPOINT URL確認**
   - HTTPSプロトコル
   - 正しいドメイン名
   - アクセス可能なURL
2. **アプリケーション側ログ確認**
   - サーバーサイドAPIが正常に動作しているか

## 9. スケジュール例

### 開発・テスト環境
```
# 5分毎実行（テスト用）
cron(*/5 * * * * *)

# 1時間毎実行
cron(0 * * * * *)
```

### 本番環境
```
# 日本時間 月曜7時〜土曜6時 15分毎（推奨）
cron(*/15 22 * * 0)       # 日曜22時〜（月曜7時〜）
cron(*/15 * * * 1-5)      # 月〜金曜日終日
cron(*/15 0-21 * * 6)     # 土曜0時〜21時（〜土曜6時）
```

## まとめ
EventBridge の設定により、GMO API を定期的に監視し、ダイバージェンス検出時に自動でLINE通知が送信される仕組みが完成します。

適切なスケジュール設定と監視により、安定した自動トレーディング支援システムを構築できます。