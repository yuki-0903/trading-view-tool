# リアルタイム ダイバージェンス通知の設定

このガイドでは、現在のローソク足で完成したダイバージェンスのみを通知するように Lambda 関数を更新する手順を説明します。

## 変更内容

### シンプルなアプローチ
1. **現在足判定**: 最新のローソク足でダイバージェンスが完成したかのみをチェック
2. **DynamoDB不要**: 複雑な履歴管理なし
3. **リアルタイム**: ローソク足完成と同時に通知

### 通知タイミング
- **従来**: 過去2時間以内のすべてのダイバージェンス
- **改善後**: **現在のローソク足で完成した**ダイバージェンスのみ

## デプロイ手順

### Lambda 関数の更新

```bash
cd /Users/ootayuuki/Desktop/claude-code/trading-view-tool/aws-lambda/divergence-monitor

# デプロイパッケージのビルドとアップロード
npm run deploy
```

## 動作確認

### 1. ログの確認

CloudWatch Logs で以下のログメッセージを確認：

```
🕐 最新ローソク足時刻: 2025/01/15 14:00:00
📊 検出結果: 全5個, 現在足完成1個
✅ 現在足ダイバージェンス発見: bullish (2025/01/15 14:00:00)
```

### 2. 通知タイミングのテスト

15分間隔で監視している場合：
- 14:00に完成したローソク足でダイバージェンス → 通知される
- 13:45に完成済みのダイバージェンス → 通知されない

### 3. 複数同時発生のテスト

同じローソク足で複数のダイバージェンス（異なるタイプ・強度）が検出された場合、すべて通知される。

## トラブルシューティング

### 通知が来ない
1. CloudWatch Logs で「現在足完成」のログを確認
2. 最新ローソク足の時刻とダイバージェンス終点の時刻が一致しているか確認
3. Lambda実行時刻とローソク足完成時刻のタイミングを確認

## 仕組みの説明

### 動作原理
1. **データ取得**: 最新の数日間のKLineデータを取得
2. **ダイバージェンス検出**: 全期間でダイバージェンス分析を実行
3. **現在足フィルタ**: 最新ローソク足で終点となるダイバージェンスのみ抽出
4. **通知送信**: フィルタされたダイバージェンスを通知

### メリット
- **シンプル**: 複雑な状態管理不要
- **確実**: ローソク足完成と同時に確実に通知
- **複数対応**: 同時に複数のダイバージェンスが発生しても全て通知
- **メンテナンス不要**: データベース管理不要

### 実行例
```
時刻: 14:00 (1時間足の場合)
↓
13:00-14:00のローソク足が完成
↓
ダイバージェンス分析実行
↓
14:00時点で終了するダイバージェンスを検出
↓
LINE通知送信
```

## 監視とメンテナンス

### CloudWatch メトリクス
- Lambda 実行回数
- エラー率
- 通知送信成功率

### 定期確認
- Lambda ログの確認
- 通知タイミングの精度検証